---
name: Release

on:
  workflow_call:

jobs:
    release:
        runs-on: ubuntu-latest
        concurrency: release

        steps:
            # check-out repo
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                ref: ${{ github.head_ref }}
                token: ${{ secrets.GH_TOKEN }}
                fetch-depth: 0
            # install poetry
            - name: Install poetry
              run: pipx install poetry==1.6.0
            # set-up python with cache
            - name: Setup Python 3.10
              uses: actions/setup-python@v4
              with:
                python-version: '3.10'
                cache: 'poetry'
            # install requirements
            - name: Install requirements
              run: poetry install --only semver
            # semantic release
            - name: Python Semantic Release
              env:
                GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                set -o pipefail
                # Set git details
                git config --global user.name "github-actions"
                git config --global user.email "github-actions@github.com"
                # run semantic-release
            
            - name: Build and publish to pypi
              uses: JRubics/poetry-publish@v1.17
              with:
                pypi_token: ${{ secrets.TEST_PYPI_TOKEN }}
                repository_name: "testpypi"
                repository_url: "https://test.pypi.org/legacy/"
